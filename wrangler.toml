name = "umbrella-api"
main = "api/index.ts"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

# Environment variables
[vars]
USE_MOCKS = "true"  # Use mock services for development (set to "false" in M10 for real services)
ENVIRONMENT = "development"  # Environment name (development, staging, production)

# =============================================================================
# EXTERNAL SERVICE API CONFIGURATION (Task 10.7)
# =============================================================================
# All secrets should be set using Wrangler CLI, never committed to git
# Reference: docs/api-configuration.md

# Clerk Configuration (Authentication)
# Get keys from: https://dashboard.clerk.com
# Set secrets via:
#   wrangler secret put CLERK_SECRET_KEY
#   wrangler secret put CLERK_WEBHOOK_SECRET
# CLERK_PUBLISHABLE_KEY = "pk_test_..."  # Public key (can be in vars)
# Secrets (set via wrangler secret put):
#   - CLERK_SECRET_KEY
#   - CLERK_WEBHOOK_SECRET

# Resend Configuration (Email Service)
# Sign up at: https://resend.com
# Documentation: https://resend.com/docs
# Set secret via: wrangler secret put RESEND_API_KEY --env production
# Secret required:
#   - RESEND_API_KEY: API key from Resend dashboard
# Note: Emails will be mocked when USE_MOCKS="true"

# Twilio Configuration (SMS Service - D-045)
# Sign up at: https://www.twilio.com
# Get credentials from: https://console.twilio.com
# Set secrets via:
#   wrangler secret put TWILIO_ACCOUNT_SID --env production
#   wrangler secret put TWILIO_AUTH_TOKEN --env production
#   wrangler secret put TWILIO_PHONE_NUMBER --env production
# Secrets required:
#   - TWILIO_ACCOUNT_SID: Account SID from Twilio console
#   - TWILIO_AUTH_TOKEN: Auth token from Twilio console
#   - TWILIO_PHONE_NUMBER: Your Twilio phone number (E.164 format: +1234567890)
# Note: SMS will be mocked when USE_MOCKS="true"

# Claude AI Configuration (Content Generation - D-058, D-059, D-066, D-074)
# Get API key from: https://console.anthropic.com
# Documentation: https://docs.anthropic.com
# Set secret via: wrangler secret put CLAUDE_API_KEY --env production
# Secret required:
#   - CLAUDE_API_KEY: API key from Anthropic console
# Features:
#   - Artist bio generation (D-058)
#   - Cover letter generation (D-074)
#   - EPK generation (D-066)
#   - Token limit: 25,000/month per user (D-059)
# Note: AI generation will be mocked when USE_MOCKS="true"

# Sentry Configuration (Error Tracking - Optional)
# Sign up at: https://sentry.io
# Get DSN from: https://sentry.io/settings/projects/
# Set secret via: wrangler secret put SENTRY_DSN --env production
# Secret (optional):
#   - SENTRY_DSN: Data Source Name from Sentry project settings

# Assets configuration for serving frontend as SPA from Workers
[assets]
directory = "./dist"
binding = "ASSETS"
not_found_handling = "single-page-application"

# Preview environment (for PR deployments)
[env.preview]
name = "umbrella-api-preview"

[env.preview.vars]
USE_MOCKS = "true"
ENVIRONMENT = "preview"

[[env.preview.d1_databases]]
binding = "DB"
database_name = "umbrella-dev-db"
database_id = "4fbcb5f8-5fe5-4bb1-b56f-0de1e80d6e8a"

[[env.preview.kv_namespaces]]
binding = "KV"
id = "04fceb9a09054bbd991d5252a9a169cf"

# R2 Storage Configuration (Task 10.7 - D-028: 24-hour download links)
# Create bucket via: wrangler r2 bucket create umbrella-dev-media
# CORS must be configured for presigned URLs
# Uncomment when R2 is available (requires billing)
# [[env.preview.r2_buckets]]
# binding = "BUCKET"
# bucket_name = "umbrella-dev-media"

# Development environment (for local testing)
[env.dev]
name = "umbrella-api-dev"

[env.dev.vars]
USE_MOCKS = "true"
ENVIRONMENT = "development"

[[env.dev.d1_databases]]
binding = "DB"
database_name = "umbrella-dev-db"
database_id = "4fbcb5f8-5fe5-4bb1-b56f-0de1e80d6e8a"

[[env.dev.kv_namespaces]]
binding = "KV"
id = "04fceb9a09054bbd991d5252a9a169cf"

# R2 Storage Configuration (Task 10.7 - D-028: 24-hour download links)
# Create bucket via: wrangler r2 bucket create umbrella-dev-media
# Uncomment when R2 is available (requires billing)
# [[env.dev.r2_buckets]]
# binding = "BUCKET"
# bucket_name = "umbrella-dev-media"

# Staging environment (for future use)
[env.staging]
name = "umbrella-api-staging"

[env.staging.vars]
USE_MOCKS = "true"
ENVIRONMENT = "staging"

[[env.staging.d1_databases]]
binding = "DB"
database_name = "umbrella-dev-db"
database_id = "4fbcb5f8-5fe5-4bb1-b56f-0de1e80d6e8a"

[[env.staging.kv_namespaces]]
binding = "KV"
id = "04fceb9a09054bbd991d5252a9a169cf"

# Production environment
[env.production]
name = "umbrella-prod"
workers_dev = false
# Custom domain configuration (requires DNS setup)
# route = "umbrella.app/*"

# Production database binding
[env.production.vars]
USE_MOCKS = "false"
ENVIRONMENT = "production"

[[env.production.d1_databases]]
binding = "DB"
database_name = "umbrella-prod-db"
# TODO: Replace with actual production database ID after creating via:
# wrangler d1 create umbrella-prod-db --env production
# Using dev database temporarily for initial deployment
database_id = "4fbcb5f8-5fe5-4bb1-b56f-0de1e80d6e8a"

# Production KV namespace binding
[[env.production.kv_namespaces]]
binding = "KV"
# TODO: Replace with actual production KV namespace ID after creating via:
# wrangler kv:namespace create KV --env production
# Using dev KV namespace temporarily for initial deployment
id = "04fceb9a09054bbd991d5252a9a169cf"

# Production R2 bucket binding
[[env.production.r2_buckets]]
binding = "BUCKET"
bucket_name = "umbrella-prod"
# Bucket should be created via:
# wrangler r2 bucket create umbrella-prod

# Production cron triggers
# Analytics aggregation: Daily at midnight UTC
[env.production.triggers]
crons = ["0 0 * * *"]

# Development/Staging cron triggers
[triggers]
crons = ["0 0 * * *"]
